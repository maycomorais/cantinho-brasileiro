<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imprimir Comanda - Cantinho Brasileiro</title>
    <style>
        body { font-family: 'Courier New', Courier, monospace; background: #eee; padding: 20px; }
        
        .ticket {
            background: #fff;
            max-width: 300px;
            margin: 0 auto;
            padding: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        h3, p { margin: 0; padding: 0; }
        h3 { text-align: center; margin-bottom: 5px; font-size: 16px; }
        .centered { text-align: center; font-size: 12px; margin-bottom: 10px; }
        
        hr { border-top: 1px dashed #000; margin: 8px 0; }
        
        .info-group { margin-bottom: 5px; font-size: 12px; }
        .info-group strong { display: inline-block; width: 60px; }

        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { text-align: left; border-bottom: 1px dashed #000; }
        td { vertical-align: top; padding: 2px 0; }
        
        .totals { text-align: right; font-size: 12px; margin-top: 10px; }
        .total-final { font-size: 16px; font-weight: bold; margin-top: 5px; }

        .btn-print {
            display: block; width: 100%; padding: 15px; background: #1a7a2e; 
            color: white; border: none; font-size: 16px; font-weight: bold; 
            cursor: pointer; margin-top: 20px; border-radius: 8px;
        }

        @media print {
            body { background: none; padding: 0; margin: 0; }
            .btn-print { display: none; }
            .ticket { box-shadow: none; max-width: 100%; width: 100%; margin: 0; }
            @page { margin: 0; }
        }
    </style>
<base target="_blank">
</head>
<body>

    <div class="ticket">
        <h3>CANTINHO BRASILEIRO</h3>
        <p class="centered" style="font-weight:bold; font-size:14px; margin-top:5px;">PEDIDO #<span id="id-pedido">---</span></p>
        <p class="centered"></p>
        <p class="centered">Tel: +595 982 808985</p>
        <hr>
        
        <div class="info-group">
            <strong>Data:</strong> <span id="data-hora">---</span><br>
            <strong>Cliente:</strong> <span id="nome">---</span><br>
            <strong>Tel:</strong> <span id="tel">---</span>
        </div>
        <hr>

        <div style="text-align:center; font-weight:bold; font-size:14px; margin:5px 0;">
            <span id="tipo-entrega">---</span>
        </div>
        <div id="endereco-box" style="font-size:11px; margin-bottom:5px; display:none;">
            Ref: <span id="ref-entrega">---</span>
        </div>
        <hr>

        <table>
            <thead>
                <tr>
                    <th style="width:15%">Qtd</th>
                    <th>Item</th>
                    <th style="text-align:right">Total</th>
                </tr>
            </thead>
            <tbody id="lista-itens">
                <tr><td colspan="3" style="text-align:center;padding:10px;">Carregando...</td></tr>
            </tbody>
        </table>
        <hr>

        <div class="totals">
            Subtotal: <span id="subtotal">Gs 0</span><br>
            Frete: <span id="frete">Gs 0</span><br>
            <div class="total-final">TOTAL: <span id="total-geral">Gs 0</span></div>
        </div>
        <hr>

        <div class="info-group">
            <strong>Pagto:</strong> <span id="forma-pag">---</span><br>
            <div id="obs-pag" style="margin-top:2px; font-style:italic;"></div>
        </div>

        <div id="box-factura" style="display:none; margin-top:10px; border:1px solid #000; padding:5px;">
            <strong>DADOS FACTURA:</strong><br>
            RUC: <span id="ruc">---</span><br>
            Raz√£o: <span id="razao">---</span>
        </div>

        <br>
        <p class="centered">*** OBRIGADO PELA PREFER√äNCIA ***</p>
    </div>

    <button class="btn-print" onclick="window.print()">üñ®Ô∏è IMPRIMIR PEDIDO</button>

    <script>
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const codigoBase64 = params.get('d');
            
            if(!codigoBase64) {
                document.body.innerHTML = "<h3 style='text-align:center; color:red; margin-top:50px'>Erro: Link inv√°lido ou incompleto.</h3>";
                return;
            }

            try {
                // Decodifica Base64 URL-safe -> JSON
                // Reverte substitui√ß√µes: - volta para +, _ volta para /
                const base64Normal = codigoBase64
                    .replace(/-/g, '+')
                    .replace(/_/g, '/');
                // Adiciona padding = se necess√°rio
                const pad = base64Normal.length % 4;
                const base64Padded = pad ? base64Normal + '='.repeat(4 - pad) : base64Normal;
                
                const jsonString = decodeURIComponent(escape(atob(base64Padded)));
                const pedido = JSON.parse(jsonString);
                
                console.log('Pedido recebido:', pedido);

                // ID DO PEDIDO
                document.getElementById('id-pedido').innerText = pedido.id || 'S/N';

                // 1. Cabe√ßalho
                document.getElementById('data-hora').innerText = pedido.data || new Date().toLocaleString('pt-BR');
                document.getElementById('nome').innerText = pedido.cliente?.nome || 'Cliente';
                document.getElementById('tel').innerText = pedido.cliente?.tel || 'S/N';

                // 2. Entrega
                const tipoEntrega = pedido.entrega?.tipo || 'delivery';
                document.getElementById('tipo-entrega').innerText = tipoEntrega.toUpperCase();
                
                if(tipoEntrega === 'delivery') {
                    document.getElementById('endereco-box').style.display = 'block';
                    document.getElementById('ref-entrega').innerText = pedido.entrega?.ref || 'N√£o informado';
                }

                // 3. Itens 
                const tbody = document.getElementById('lista-itens');
                tbody.innerHTML = '';
                
                console.log('üç£ Itens recebidos:', JSON.stringify(pedido.itens));
                
                const itens = Array.isArray(pedido.itens) ? pedido.itens : [];
                if (itens.length > 0) {
                    itens.forEach((item, idx) => {
                        console.log('Item '+idx+':', JSON.stringify(item));
                        const tr = document.createElement('tr');
                        
                        // Extrai quantidade: aceita q, qtd, quantidade ‚Äî fallback 1
                        const quantidade = (item.q !== undefined ? item.q : null) 
                                        || (item.qtd !== undefined ? item.qtd : null)
                                        || (item.quantidade !== undefined ? item.quantidade : null)
                                        || 1;
                        
                        // Extrai nome
                        const nomeItem = item.n || item.nome || item.name || ('Item '+(idx+1));
                        
                        // Extrai pre√ßo ‚Äî usa parseFloat para garantir n√∫mero
                        const preco = parseFloat(item.p !== undefined ? item.p : (item.preco !== undefined ? item.preco : (item.valor || 0))) || 0;
                        
                        const montagem = item.m || item.montagem || [];
                        const observacao = item.o || item.obs || item.observacao || '';
                        const tipo = item.t || item.tipo || '';
                        
                        let detalhes = '';
                        if (tipo && tipo !== 'Padr√£o' && tipo !== 'Montado') detalhes += '<br><small>('+tipo+')</small>';
                        if (Array.isArray(montagem) && montagem.length > 0) detalhes += '<br><small style="font-style:italic">Ing: '+montagem.join(', ')+'</small>';
                        if (observacao) detalhes += '<br><strong style="font-size:10px">OBS: '+observacao+'</strong>';
                        
                        const total = (preco * quantidade).toLocaleString('es-PY');
                        tr.innerHTML = '<td style="vertical-align:top">'+quantidade+'x</td><td>'+nomeItem+detalhes+'</td><td style="text-align:right">Gs '+total+'</td>';
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#e74c3c;">Nenhum item encontrado</td></tr>';
                }

                // 4. Totais
                const valores = pedido.valores || {};
                document.getElementById('subtotal').innerText = `Gs ${(valores.sub || valores.subtotal || 0).toLocaleString('es-PY')}`;
                document.getElementById('frete').innerText = `Gs ${(valores.frete || valores.frete_cobrado_cliente || 0).toLocaleString('es-PY')}`;
                document.getElementById('total-geral').innerText = `Gs ${(valores.total || valores.total_geral || 0).toLocaleString('es-PY')}`;

                // 5. Pagamento
                const pagamento = pedido.pagamento || {};
                document.getElementById('forma-pag').innerText = pagamento.metodo || pagamento.forma_pagamento || 'N√£o informado';
                document.getElementById('obs-pag').innerText = pagamento.obs || pagamento.obs_pagamento || '';

                // 6. Factura
                if(pedido.factura && (pedido.factura.ruc || pedido.factura.razao)) {
                    document.getElementById('box-factura').style.display = 'block';
                    document.getElementById('ruc').innerText = pedido.factura.ruc || 'S/N';
                    document.getElementById('razao').innerText = pedido.factura.razao || 'S/N';
                }
                
                setTimeout(() => window.print(), 800);

            } catch (e) {
                console.error('Erro ao processar pedido:', e);
                document.body.innerHTML = `
                    <h3 style='text-align:center; color:red; margin-top:50px'>
                        Erro ao ler o pedido.<br><br>
                        <small>O link pode estar incompleto ou corrompido.</small><br><br>
                        <button onclick="window.close()" style="padding:10px 20px; background:#1a7a2e; color:white; border:none; border-radius:5px; cursor:pointer;">
                            Fechar
                        </button>
                    </h3>
                `;
            }
        }
    </script>
</body>
</html>